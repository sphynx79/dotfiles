#!/bin/bash

# Path del file cache
cache_file="${XDG_RUNTIME_DIR}/tmp/keybinds_hint.rofi"
script_path="$HOME/.config/hypr/bin/keybinds.hint.py"

# Leggi da cache se esiste, altrimenti genera
if [[ -f "$cache_file" ]]; then
  raw_output=$(cat "$cache_file")
else
  mkdir -p "${XDG_RUNTIME_DIR}/tmp"
  raw_output=$("$script_path" --format rofi 2>/dev/null)
  echo "$raw_output" > "$cache_file"
fi

# Formatta output con gruppi
output=$(echo "$raw_output" | awk -F ' ::: ' '
{
  # Salta separatori (linee di ━)
  if ($1 ~ /^━+$/) next

  # Se $2 è vuoto = header di gruppo
  if ($2 == "") {
    gsub(/^[ \t]+/, "", $1)
    gsub(/[ \t]+$/, "", $1)
    if ($1 != "") {
      print "══════ " $1 " ══════"
    }
    next
  }

  # Keybind: estrai solo la parte visibile
  line = $1
  gsub(/[ \t]+$/, "", line)

  if (line != "") {
    print "  " line
  }
}')

[ -z "$output" ] && exit 0

# Mostra in Walker
selected=$(echo "$output" | walker --dmenu \
  --width 950 \
  --height 700 \
  -p "⌨️ Keybindings")

[ -z "$selected" ] && exit 0

# Se è un header, esci
[[ "$selected" =~ ^══ ]] && exit 0

echo "Selezionato: $selected"
